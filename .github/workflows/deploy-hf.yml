name: Deploy to Hugging Face Spaces

on:
  push:
    branches: [main, master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Frontend (this repo) - full history
        uses: actions/checkout@v4
        with:
          path: frontend
          fetch-depth: 0

      - name: Checkout Backend - full history
        uses: actions/checkout@v4
        with:
          repository: mouniksai/vote-guard-server
          path: frontend/vote-guard-server
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Remove nested .git
        run: rm -rf frontend/vote-guard-server/.git

      - name: Inject .env file from GitHub secret
        run: |
          echo "${{ secrets.DOTENV_FILE }}" > frontend/vote-guard-server/.env

      - name: Install git-lfs
        run: |
          sudo apt-get update
          sudo apt-get install -y git-lfs

      - name: Push to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_SPACE: ${{ secrets.HF_SPACE_NAME }}
        run: |
          cd frontend
          git lfs install
          git config user.email "ci@voteguard.com"
          git config user.name "VoteGuard CI"

          # Force-add backend files (overrides .gitignore which excludes vote-guard-server/)
          git add --force vote-guard-server/
          git add -A
          git commit -m "Deploy: frontend + backend ($(date '+%Y-%m-%d %H:%M'))" --allow-empty
          git push --force https://USER:${HF_TOKEN}@huggingface.co/spaces/${HF_SPACE} HEAD:main
